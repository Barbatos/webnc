var quakenet = {
      name: 'Quakenet',
      subject: 'Super sujet de la mort qui tue',
      notifs : 5,
      messages : [
        {date: '13:31', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:33', from: 'pandy',   content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:38', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:39', from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var frozensand = {
      name: '#frozensand',
      subject: 'Super sujet de la mort qui tue',
      notifs : 9,
      messages : [
        {date: '13:31', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:33', from: 'pandy',   content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:38', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:39', from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var pandy = {
      name: 'pandy',
      subject: 'Super sujet de la mort qui tue',
      notifs : 0,
      messages : [
        {date: '13:31', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:33', from: 'pandy',   content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:38', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:39', from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var csli = {
      name: 'csli',
      subject: 'Super cslicsli csli la mort qui tue',
      notifs : 0,
      messages : [
        {date: '13:31', from: 'holblin', content: 'Lorem ipsum csli sit amet, consectetupteur sint <h1>csli</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:33', from: 'pandy',   content: 'cupidatat non csli, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'holblin', content: 'Lorem ipsum dolor sit amet, csli sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:38', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:39', from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var freenode = {
      name: 'Freenode',
      subject: 'frozensand subject !!!',
      notifs : 8,
      messages : [
        {date: '13:31', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:33', from: 'raider',  content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'raider',  content: 'officia deserunt mollit anim id est laborum.' },
        {date: '13:37', from: 'raider',  content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:38', from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: '13:39', from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };


function get_angular(){
  return angular.element(document.body).scope();
}


var socket = null;
var $scope = null;
$(function(){
  
  $(".focus").focus();

  $scope = get_angular();

  socket = io.connect('http://localhost:8080');
  socket.on('connected', function (data) {
    socket.login_key = data.key;
  });

  socket.on('logged', function (data) {
    $scope.$apply(function(){
      // we are now auth logged
      $scope.username = $("#login-username").val();
      setTimeout(function(){ // simulate websocket get servers and channels
        // add servers and channels
        $scope.addServer( 0 , quakenet );
        $scope.addChannel( 0 , 0, frozensand );
        $scope.addChannel( 0 , 1, pandy );
        $scope.addServer( 1 , freenode );
        $scope.addChannel( 1 , 0, csli );

        $scope.selectTab('0'); // select first server
        $scope.$apply(); // apply modifications
        
        $(".bs-docs-sidebar ul li:first a").trigger('click'); // drop a bug with css
        $("[data-spy=affix]").affix(); // drop a bug with bootstrap affix

      }, 500);

    })
  })

  socket.on('login failled', function (data) {
    $scope.$apply(function(){
      // we are now auth logged
      $scope.username = '';
    })
  })
})


angular.module("myApp", []).controller("Webnc", function($scope) {


  $scope.username = '';


  $scope.tabs = [];
  $scope.selected_tab = '';

  $scope.selectTab = function( name ){
    $scope.selected_tab = name;
  }

  $scope.test = function( arg ){
    var i = 0;
    for (i = 0 ; i < 10 ; i++){
      $scope.addMessage( 0 , null, {date: '13:96', from:'asche', content:'TOTO'} );
      $scope.addMessage( 0 , 0, {date: '13:96', from:'asche', content:'TOTO'} );
    }
  }

  $scope.login = function(){
    var credital = md5( socket.login_key + $("#login-password").val() )
    $("#login-password").val('');

    socket.emit('auth', { password: credital, username: $("#login-username").val() });
  }

  $scope.addServer = function( serverKey , server ){
    // We REFUSE to REPLACE a server
    if ( typeof $scope.tabs[serverKey] != "undefined" )
      return false;

    $scope.tabs[serverKey] = server;
    $scope.tabs[serverKey].key = serverKey;
    $scope.tabs[serverKey].channels = [];
    return true;
  }

  $scope.addChannel = function( serverKey , channelKey,  channel ){
    // serverKey MUST be set
    if ( typeof $scope.tabs[serverKey] == "undefined" )
      return false;

    // We REFUSE to REPLACE a channel
    if ( typeof $scope.tabs[serverKey].channels[ channelKey ] != "undefined" )
      return false;

    $scope.tabs[serverKey].channels[ channelKey ] = channel;
    $scope.tabs[serverKey].channels[ channelKey ].key = serverKey+ ':' + channelKey;
    return true;
  }

  $scope.addMessage = function( serverKey, channelKey, message ){
    // serverKey MUST be set
    if ( typeof $scope.tabs[serverKey] == "undefined" )
      return false;
    
    if (channelKey == null ){
      $scope.tabs[serverKey].messages.push( message );
      return true;
    }
    else {
      // channelKey must be set too
      if ( typeof $scope.tabs[serverKey].channels[ channelKey ] == "undefined" )
        return false;

      $scope.tabs[serverKey].channels[ channelKey ].messages.push( message );
      return true;
    }
  }

})
