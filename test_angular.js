var quakenet = {
      name: 'Quakenet',
      subject: 'Super sujet de la mort qui tue',
      notifs : 5,
      messages : [
        {date: new Date('02/26/13 13:31'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:33'), from: 'pandy',   content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:38'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 17:09'), from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var frozensand = {
      name: '#frozensand',
      subject: 'Super sujet de la mort qui tue',
      notifs : 9,
      messages : [
        {date: new Date('02/26/13 13:31'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:33'), from: 'pandy',   content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:38'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:39'), from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var pandy = {
      name: 'pandy',
      subject: 'Super sujet de la mort qui tue',
      notifs : 0,
      messages : [
        {date: new Date('02/26/13 13:31'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:33'), from: 'pandy',   content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:37'), from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:38'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:39'), from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var csli = {
      name: 'csli',
      subject: 'Super cslicsli csli la mort qui tue',
      notifs : 0,
      messages : [
        {date: new Date('02/26/13 13:31'), from: 'holblin', content: 'Lorem ipsum csli sit amet, consectetupteur sint <h1>csli</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:33'), from: 'pandy',   content: 'cupidatat non csli, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, csli sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'pandy',   content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:38'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:39'), from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };
var freenode = {
      name: 'Freenode',
      subject: 'frozensand subject !!!',
      notifs : 8,
      messages : [
        {date: new Date('02/26/13 13:31'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint <h1>occaecat</h1> cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:33'), from: 'raider',  content: 'cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'raider',  content: 'officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 13:37'), from: 'raider',  content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:38'), from: 'holblin', content: 'Lorem ipsum dolor sit amet, consectetupteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.' },
        {date: new Date('02/26/13 18:39'), from: 'holblin', content: 'officia deserunt mollit anim id est laborum.' }
      ]
    };


function get_angular(){
  return angular.element(document.body).scope();
}


var socket = null;
var $scope = null;
$(function(){
  
  $(".focus").focus();

  $scope = get_angular();

  socket = io.connect('http://localhost:8080');
  socket.on('connected', function (data) {
    socket.login_key = data.key;
  });

  socket.on('logged', function (data) {
    $scope.$apply(function(){
      // we are now auth logged
      $scope.username = $("#login-username").val();
      setTimeout(function(){ // simulate websocket get servers and channels
        // add servers and channels
        $scope.addTab( '0'   , quakenet );
        $scope.addTab( '0:0' , frozensand );
        $scope.addTab( '0:1' , pandy );
        $scope.addTab( '1'   , freenode );
        $scope.addTab( '1:0' , csli );

        $scope.selectTab('0'); // select first server
        $scope.$apply(); // apply modifications
        
        $(".bs-docs-sidebar ul li:first a").trigger('click'); // drop a bug with css
        $("[data-spy=affix]").affix(); // drop a bug with bootstrap affix

      }, 500);

    })
  })

  socket.on('login failled', function (data) {
    $scope.$apply(function(){
      // we are now auth logged
      $scope.username = '';
    })
  })
})


function getObjKey( key ){
  if ( typeof key == "string" ){
    var tmp = key.split(':');
    key = { server: null , channel: null };
    key.server = tmp[0];
    if ( tmp.length == 2)
      key.channel = tmp[1];
    return key;
  }
  else {
    if ( typeof key.channel == "undefined" ){
      key.channel = null;
    }
    return key;
  }
}

function getStrKey( key ){
  if ( typeof key != "string" ){
    var tmp = ""
    tmp += key.server;
    if ( typeof key.channel != "undefined" && key.channel != null )
      tmp += ":" + key.channel;
    return tmp;
  }
  else
    return key;
}

angular.module("myApp", []).controller("Webnc", function($scope) {

  $scope.username = '';


  $scope.tabs = [];
  $scope.selected_tab = '';
  

  $scope.test = function( arg ){
    var i = 0;
    for (i = 0 ; i < 10 ; i++){
      $scope.addMessage( { server: 0 } ,             {date: new Date('02/26/13 13:56'), from:'asche', content: md5(Math.random()) } );
      $scope.addMessage( { server: 0 , channel: 0 }, {date: new Date('02/26/13 13:56'), from:'asche', content: md5(Math.random()) } );
    }
  }


  $scope.tabExist = function( key ){
    key = getObjKey( key );
    if ( key.channel == null ){
      if ( typeof $scope.tabs[ key.server ] != "undefined" )
        return true;
      else
        return false;
    } else {
      if ( typeof $scope.tabs[ key.server ] == "undefined" )
        return -1;

      if ( typeof $scope.tabs[ key.server ].channels[ key.channel ] != "undefined" )
        return true;
      else
        return false;
    }
  }

  $scope.getTab = function( key ){
    key = getObjKey( key )
    if ( $scope.tabExist(key) !== true )
      return false;
    if ( key.channel == null )
      return $scope.tabs[ key.server ];
    else
      return $scope.tabs[ key.server ].channels[ key.channel ];
  }


  $scope.selectTab = function( key ){
    // save current scroll Height
    var last_selected = $scope.getTab( $scope.selected_tab )
    last_selected.scrollTop = $(document.body).prop('scrollTop');
    last_selected.last_seen = new Date();

    // switch tab
    $scope.selected_tab = getStrKey( key );
    //restaure scroll Height
    $(document.body).stop(true, true).prop({scrollTop: $scope.getTab( $scope.selected_tab ).scrollTop }, 50)
    // clear notiffs
    $scope.getTab(key).notifs = 0;
  }

  $scope.login = function(){
    var credital = md5( socket.login_key + $("#login-password").val() )
    $("#login-password").val('');

    socket.emit('auth', { password: credital, username: $("#login-username").val() });
  }

  $scope.addTab = function( key , tab ){  
    key = getObjKey( key );
    if ( key.channel == null ){
      // We REFUSE to REPLACE a server
      if ( $scope.tabExist(key) !== false )
        return false;

      $scope.tabs[ key.server ]           = tab;
      $scope.tabs[ key.server ].scrollTop = 0;
      $scope.tabs[ key.server ].last_seen = new Date();
      $scope.tabs[ key.server ].key       = getStrKey( key );
      $scope.tabs[ key.server ].channels  = [];

    } else {
      // We REFUSE to REPLACE a channel and the server MUST exist
      if ( $scope.tabExist(key) !== false )
        return false;

      $scope.tabs[ key.server ].channels[ key.channel ]           = tab;
      $scope.tabs[ key.server ].channels[ key.channel ].scrollTop = 0;
      $scope.tabs[ key.server ].channels[ key.channel ].last_seen = new Date();
      $scope.tabs[ key.server ].channels[ key.channel ].key       = getStrKey( key );
      return true;
    }
  }

  $scope.addMessage = function( key , message ) {
    
    var tab = $scope.getTab( key )
    tab.messages.push( message );

    if ( $scope.selected_tab != getStrKey(key) ){
      tab.notifs ++;
    } else {
      $(document.body).stop(true, true).animate({scrollTop: $(document.body).prop('scrollHeight')}, 500)
    }
    return true;
  }

})
